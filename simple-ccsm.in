#!/usr/bin/env python
# -*-  coding: UTF-8 -*-

# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, 
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#
# Authors: Patrick Niklaus (marex@opencompositing.org)
# Copyright (C) 2007 Patrick Niklaus

import shutil
import os
import subprocess
import pygtk
import gtk
import gobject
import gtk.gdk as gdk
import gtk.glade as glade
import cairo
import compizconfig as ccs
import ccm
import locale
import gettext
from optparse import OptionParser
locale.setlocale(locale.LC_ALL, "")
_ = gettext.gettext

DataDir = '@prefix@/share/simple-ccsm/'
Profiles = [\
"Low Effects", "Easy to the eyes", "Medium Effects", "High Effects", "Hollywood got nothing"
]

# Use the Compiz Fusion translation to identify option values/descriptions
# But remember using the ' symbol instead of ", otherwise gettext will add it
# to simple-ccsm's pot file
# FIXME use compiz prefix
gettext.bindtextdomain("compiz-fusion-plugins", "@prefix@/share/locale")
gettext.textdomain("compiz-fusion-plugins")

# 0 to 10 points
AnimationRatings = {\
_('None'): 0,
_('Random'): 5,
_('Airplane'): 10,
_('Beam Up'): 7,
_('Burn'): 8,
_('Curved Fold'): 4,
_('Domino'): 6,
_('Dream'): 6,
_('Explode'): 7,
_('Fade'): 3,
_('Fold'): 6,
_('Glide 1'): 6,
_('Glide 2'): 6,
_('Horizontal Folds'): 6,
_('Leaf Spread'): 8,
_('Magic Lamp'): 10,
_('Razr'): 8,
_('Sidekick'): 6,
_('Skewer'): 6,
_('Vacuum'): 8,
_('Wave'): 8,
_('Zoom'): 4
}

gtk.glade.bindtextdomain("simple-ccsm", "@prefix@/share/locale")
gettext.bindtextdomain("simple-ccsm", "@prefix@/share/locale")
gettext.textdomain("simple-ccsm")

# Possible are 74 points (cube and wall conflict)
EffectPluginRatings = {\
'wobbly': 10,
'cube': 3,
'wall': 2,
'expo': 5,
'blur': 8,
'mblur': 10,
'3d': 8,
'water': 10,
'firepaint': 7,
'shift': 5,
'cubereflex': 8
}

Pages = {
'profile': 0,
'animations': 1,
'desktop': 2,
'accessibility': 3
}

# Possible are 2 Points
AccessibilityPlugins = {\
'zoom': 1,
'ezoom': 1,
'colorfilter': 1
}

class DesktopPreview(gtk.Widget):
    def __init__(self, size=(0,0)):
        gtk.Widget.__init__(self)

        self.size = size
        self.desktop_height = 30
        self.desktop_width = 40
        self.desktop_space = 5
        self.line_width = 1.0

        self.set_flags(self.flags() | gtk.NO_WINDOW)

    def set_value(self, size):
        self.size = size
        self.queue_resize()

    def get_value(self):
        return self.size
    
    def do_unrealize(self):
        self.window.destroy()

    def do_size_request(self, req):
        if self.size[0] >= 5 or (self.size[1] >= 5 and self.size[1] <= 7):
            self.desktop_height = 15
            self.desktop_width = 20
        elif self.size[1] > 7:
            self.desktop_height = 8
            self.desktop_width = 10
        else:
            self.desktop_height = 30
            self.desktop_width = 40
        
        req.height = (self.desktop_height+self.desktop_space)*self.size[1] - self.desktop_space + self.line_width
        req.width = (self.desktop_width+self.desktop_space)*self.size[0] - self.desktop_space + self.line_width 

    def do_expose_event(self, event):
        cr = self.window.cairo_create()
        
        fg = self.style.bg[gtk.STATE_SELECTED]
        dark = self.style.fg[gtk.STATE_NORMAL]

        x = self.allocation.x + self.line_width / 2.0
        y = self.allocation.y + self.line_width / 2.0
        for i in range(self.size[1]):
            for j in range(self.size[0]):
                cr.set_source_rgb(fg.red/65535.0,
                              fg.green/65535.0,
                              fg.blue/65535.0)

                cr.rectangle(x, y, self.desktop_width, self.desktop_height)
                cr.fill_preserve()
                
                cr.set_line_width(self.line_width)
                cr.set_source_rgb(dark.red/65535.0,
                              dark.green/65535.0,
                              dark.blue/65535.0)
                cr.stroke()

                x += self.desktop_width + self.desktop_space

            y += self.desktop_height + self.desktop_space 
            x = self.allocation.x + self.line_width / 2.0

class StarScale(gtk.Widget):
    def __init__(self, stars=0.0):
        gtk.Widget.__init__(self)

        self.stars = stars
        self.star_size = 16
        self.star_space = 5

        self.star_surface = cairo.ImageSurface.create_from_png("%s/star.png" % DataDir)
        
        self.set_flags(self.flags() | gtk.NO_WINDOW)

    def set_value(self, stars):
        self.stars = stars
        self.queue_resize()

    def get_value(self):
        return self.stars
    
    def do_size_request(self, req):
        req.height = self.star_size
        req.width = (self.star_size+self.star_space)*self.stars 

    def do_expose_event(self, event):
        cr = self.window.cairo_create()  

        x = self.allocation.x
        y = self.allocation.y
        i = self.stars
        while i > 0:
            size = 1.0
            if i < 1:
                size = i
            cr.set_source_surface(self.star_surface, x, y)
            cr.rectangle(x, y, self.star_size*size, self.star_size)
            cr.fill()
            x += self.star_size + self.star_space
            i -= 1


gobject.type_register(StarScale)
gobject.type_register(DesktopPreview)

class CheckImage(gtk.Image):
    def __init__(self, value=False):
        gtk.Image.__init__(self)

        self.value = value

        self.update_image()
    
    def set_value(self, value):
        self.value = value

        self.update_image()

    def get_value(self):
        return self.value
    
    def update_image(self):
        size = gtk.ICON_SIZE_BUTTON
        if self.value:
            self.set_from_stock(gtk.STOCK_APPLY, size)
        else:
            self.set_from_stock(gtk.STOCK_DIALOG_ERROR, size)

class MainWin:
    def __init__(self, context, page = -1):
        self.GladeXML = glade.XML(DataDir + "simple-ccsm.glade", domain="simple-ccsm")
		
        self.Context = context
        self.Block = 0

	if page != -1 and page in Pages:
	    notebook = self.GladeXML.get_widget("notebook1")
	    notebook.set_current_page (Pages[page])

        self.Window = self.GladeXML.get_widget("mainWin")
        self.Window.connect('destroy', self.Quit)
        self.Window.set_icon(gtk.gdk.pixbuf_new_from_file("@prefix@/share/icons/hicolor/scalable/apps/simple-ccsm.svg"))

        self.ProfileSelector = self.GladeXML.get_widget("profileSelector")
        self.ProfileSelector.connect('value-changed', self.ProfileChanged) 

        checkList = self.GladeXML.get_widget("checkList")
        self.EffectStars = StarScale()
        self.AnimationStars = StarScale()
        self.AccessibilityCheck = CheckImage()
        checkList.attach(self.AnimationStars, 1, 2, 0, 1, gtk.EXPAND)
        checkList.attach(self.EffectStars, 1, 2, 1, 2, gtk.EXPAND)
        checkList.attach(self.AccessibilityCheck, 1, 2, 3, 4, gtk.EXPAND)

        desktopTable = self.GladeXML.get_widget("desktopTable")
        self.DesktopPreview = DesktopPreview()
        desktopTable.attach(self.DesktopPreview, 1, 2, 5, 6, gtk.EXPAND, 0)
        
        self.CurrentProfile = self.GladeXML.get_widget("currentProfile")
        self.ProfileLayout = "<span size='large'><b>Profile:</b> %s</span>" 
        
        self.DesktopLayout = "<i><span size='large'>%s</span></i>"

        desktopBox = self.GladeXML.get_widget("desktopPluginChooser")
        desktopBox.connect('changed', self.AppearenceBoxChanged)

        desktopHSize = self.GladeXML.get_widget("horizontalDesktops")
        desktopHSize.connect('value-changed', self.DesktopSizeChanged, "hsize")
        desktopVSize = self.GladeXML.get_widget("verticalDesktops")
        desktopVSize.connect('value-changed', self.DesktopSizeChanged, "vsize")

        animationClose = self.GladeXML.get_widget("closeAnimationBox")
        animationClose.connect('changed', self.AnimationBoxChanged, "close_effects")
        animationOpen = self.GladeXML.get_widget("openAnimationBox")
        animationOpen.connect('changed', self.AnimationBoxChanged, "open_effects")
        animationMinimize = self.GladeXML.get_widget("minimizeAnimationBox")
        animationMinimize.connect('changed', self.AnimationBoxChanged, "minimize_effects")

        enableAnimations = self.GladeXML.get_widget("enableAnimations")
        enableAnimations.connect('toggled', self.EnableAnimationsChanged)
        
        enableColorFilter = self.GladeXML.get_widget("enableColorFilter")
        enableColorFilter.connect('toggled', self.AccessibilityChanged, ['colorfilter'])
        executeFilterManager = self.GladeXML.get_widget("executeFilterManager")
        executeFilterManager.connect('clicked', self.ExecFilterManager)
        enableMagnification = self.GladeXML.get_widget("enableMagnification")
        enableMagnification.connect('toggled', self.AccessibilityChanged, ['ezoom', 'zoom'])

        
        self.Update()        
        self.Window.show_all()

    def EnablePlugin(self, plugin, active):
        if self.Block > 0:
            return
        self.Block += 1
        # attempt to resolve conflicts...
        conflicts = plugin.Enabled and plugin.DisableConflicts or plugin.EnableConflicts
        conflict = ccm.PluginConflict(plugin, conflicts, autoResolve=True)
        if conflict.Resolve():
            plugin.Enabled = active
        else:
            return False
        self.Context.Write()
        self.Block = self.Block-1
        return True
    
    def SetupBoxModel(self, box):
        if not box.get_model():
            store = gtk.ListStore(gobject.TYPE_STRING)
            box.set_model(store)
            cell = gtk.CellRendererText()
            box.pack_start(cell, True)
            box.add_attribute(cell, 'text', 0)
        else:
            box.get_model().clear()
    
    def UpdateDesktopPlugins(self):
        self.DesktopPlugins = {}
        for plugin in self.Context.Plugins.values():
            if "largedesktop" in plugin.Features:
                self.DesktopPlugins[plugin.ShortDesc] = plugin
    
    def Update(self):
        self.Block += 1 
        
        self.SetProfile()
        self.SetEffectRating()
        self.SetEnableAnimations()
        self.FillAnimationBoxes()
        self.SetAnimationRating()
        self.UpdateDesktopPlugins()
        self.FillAppearenceBox()
        self.SetDesktopLabel()
        self.SetDesktopSize()
        self.SetDesktopPreview()
        self.CheckAccessibility()
        self.SetAccessibility()

        self.Block -= 1
    
    def ProfileChanged(self, widget):
        if self.Block > 0:
            return

        value = int(widget.get_value()) -1
        profile = Profiles[value]
        
        profilePath = "%s/profiles/%s.ini" % (DataDir, profile)
        if not profile in self.Context.Profiles.keys():
            self.Context.CurrentProfile = ccs.Profile(self.Context, profile)
            self.Context.UpdateProfiles()
            self.Context.Import(profilePath)
        
        else:
            self.Context.UpdateProfiles()
            self.Context.CurrentProfile = self.Context.Profiles[profile]
        
        self.Update()
    
    def SetProfile(self):
        profile = self.Context.CurrentProfile.Name
        self.CurrentProfile.set_markup(self.ProfileLayout % (profile != "" and profile or "Default"))

        if profile in Profiles:
            value = Profiles.index(profile) + 1
            self.ProfileSelector.set_value(value)
    
    def SetDesktopPreview(self):
        hsize = self.Context.Plugins['core'].Screens[0]["hsize"].Value
        vsize = self.Context.Plugins['core'].Screens[0]["vsize"].Value
        self.DesktopPreview.set_value((hsize, vsize))
    
    def DesktopSizeChanged(self, widget, settingName):
        if self.Block > 0:
            return
        value = widget.get_value()
        self.Context.Plugins['core'].Screens[0][settingName].Value = value
        self.Context.Write()
        self.SetDesktopPreview()
    
    def SetDesktopSize(self):
        scales = {"horizontalDesktops" : "hsize",
                  "verticalDesktops"   : "vsize"}

        for widgetName, settingName in scales.items():
            widget = self.GladeXML.get_widget(widgetName)
            setting = self.Context.Plugins['core'].Screens[0][settingName]
            widget.set_value(setting.Value)
    
    def SetDesktopLabel(self):
        label = self.GladeXML.get_widget("desktopLabel")
        for shortDesc, plugin in self.DesktopPlugins.items():
            if plugin.Enabled:
                label.set_markup(self.DesktopLayout % shortDesc)
                break
    
    def AppearenceBoxChanged(self, widget):
        if self.Block > 0:
            return

        text = widget.get_active_text()

        for shortDesc, plugin in self.DesktopPlugins.items():
            if text != shortDesc:
                self.EnablePlugin(plugin, False)
        
        self.Context.Write()

        for shortDesc, plugin in self.DesktopPlugins.items():
            if text == shortDesc:
                plugin.Enabled = True
                # exception for cube, since it requires rotate
                if plugin.Name == 'cube':
                    self.EnablePlugin(self.Context.Plugins['rotate'], True)

        self.Context.Write()

    def FillAppearenceBox(self):
        box = self.GladeXML.get_widget("desktopPluginChooser")
        self.SetupBoxModel(box)

        i = 0
        for shortDesc, plugin in self.DesktopPlugins.items():
            box.append_text(shortDesc)
            if plugin.Enabled:
                box.set_active(i)
            i += 1

    def SetEffectRating(self):
        rating = 0.0

        for pluginName, points in EffectPluginRatings.items():
	    if not pluginName in self.Context.Plugins:
		continue
            plugin = self.Context.Plugins[pluginName]
            if plugin.Enabled:
                rating += points

        rating = (rating / 74.0) * 5

        self.EffectStars.set_value(rating)
    
    def SetAnimationRating(self):
        boxes = ['closeAnimationBox', 'openAnimationBox', 'minimizeAnimationBox']
        
        rating = 0.0
        for box in boxes:
            box = self.GladeXML.get_widget(box)
            text = box.get_active_text()
            rating += AnimationRatings[text]
        
        if not self.Context.Plugins['animation'].Enabled:
            rating = 0.0
        if self.Context.Plugins['fade'].Enabled:
            rating += AnimationRatings[_('Fade')] * 2
        if self.Context.Plugins['minimize'].Enabled:
            rating += AnimationRatings[_('Zoom')] / 3 
        
        rating = rating / (10 * len(boxes)) * 5
        
        self.AnimationStars.set_value(rating)

    def EnableAnimationsChanged(self, widget):
        if self.Block > 0:
            return

        plugin = self.Context.Plugins['animation']
        self.EnablePlugin(plugin, widget.get_active())

        self.SetAnimationRating()

    def SetEnableAnimations(self):
        plugin = self.Context.Plugins['animation']
        widget = self.GladeXML.get_widget("enableAnimations")
        widget.set_active(plugin.Enabled)
    
    def AnimationBoxChanged(self, widget, settingName):
        if self.Block > 0:
            return

        text = widget.get_active_text()
        plugin = self.Context.Plugins['animation']
        setting = plugin.Screens[0][settingName]
        value = setting.Value
        if len(value) >= 1:
            value[0] = setting.Info[1][2][text]
            setting.Value = value
            self.Context.Write()
        else:
            for setting in plugin.Groups[setting.Group][setting.SubGroup].Screens[0].values():
                setting.Reset()
            self.Context.Write()
            self.AnimationBoxChanged(widget, settingName)

        self.SetAnimationRating()
    
    def FillAnimationBoxes(self):
        plugin = self.Context.Plugins['animation']
        
        boxes = {}
        boxes['closeAnimationBox'] =  "close_effects"
        boxes['openAnimationBox'] = "open_effects"
        boxes['minimizeAnimationBox'] = "minimize_effects"

        for boxName, settingName in boxes.items():
            box = self.GladeXML.get_widget(boxName)
            setting = plugin.Screens[0][settingName]
            items = sorted(setting.Info[1][2].items(), ccm.EnumSettingSortCompare)
            self.SetupBoxModel(box)
            for key, value in items:
                box.append_text(key)
            if len(setting.Value):
                value = setting.Value[0]
                box.set_active(value)
            else:
                box.set_active(0)
 
    def CheckAccessibility(self):
        rating = 0.0
        for name in AccessibilityPlugins.keys():
            if self.Context.Plugins.has_key(name) and self.Context.Plugins[name].Enabled:
                rating += AccessibilityPlugins[name]
        
        self.AccessibilityCheck.set_value(rating >= 2.0)
    
    def AccessibilityChanged(self, widget, pluginNames):
        if self.Block > 0:
            return
        
        plugin = None
        for name in pluginNames:
            if self.Context.Plugins.has_key(name):
                plugin = self.Context.Plugins[name]
                break
        if not plugin:
            return
        
        plugin.Enabled = widget.get_active()
        self.Context.Write()

        self.CheckAccessibility()

    
    def SetAccessibility(self):
        boxes = {}
        boxes['enableColorFilter'] = ["colorfilter"]
        boxes['enableMagnification'] = ["ezoom", "zoom"]

        for boxName, pluginNames in boxes.items():
            box = self.GladeXML.get_widget(boxName)
            
            plugin = None
            for name in pluginNames:
                if self.Context.Plugins.has_key(name):
                    plugin = self.Context.Plugins[name]
                    break
            if not plugin:
                continue

            box.set_active(plugin.Enabled)
    
    def ExecFilterManager(self, widget): 
        try:
            proc = subprocess.Popen(["filters-manager"])
        except:
            errorDialog = self.GladeXML.get_widget("filterManagerError")
            errorDialog.run()
            errorDialog.destroy()
    
    def Quit(self, widget):
        gtk.main_quit()

if __name__ == "__main__":
    context = ccs.Context()
    page = -1
    parser = OptionParser()
    parser.add_option("-p", "--page", dest = "page",
		      help = "Directly jump to page PAGE", metavar = "PAGE")
    (options, args) = parser.parse_args()
    if options.page:
	page = options.page
    mainWin = MainWin(context, page)
    gtk.main()
